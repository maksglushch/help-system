{% extends "base.html" %}

{% block content %}
<style>
    .chat-container {
        height: 400px;
        overflow-y: scroll;
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #dee2e6;
    }
    .message-bubble {
        max-width: 70%;
        padding: 10px 15px;
        border-radius: 15px;
        margin-bottom: 10px;
        position: relative;
    }
    .message-me {
        background-color: #0d6efd;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 2px;
    }
    .message-other {
        background-color: #e9ecef;
        color: black;
        margin-right: auto;
        border-bottom-left-radius: 2px;
    }
    .message-time {
        font-size: 0.7rem;
        opacity: 0.7;
        text-align: right;
        display: block;
        margin-top: 5px;
    }
</style>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üí¨ –ß–∞—Ç –ø–æ –∑–∞—è–≤—Ü—ñ: <strong>{{ ann.title }}</strong></h5>
                    <a href="{{ url_for('main.user_profile', name=current_user.name) }}" class="btn btn-sm btn-outline-secondary">–ó–∞–∫—Ä–∏—Ç–∏</a>
                </div>
                
                <div class="card-body">
                    <div id="chat-box" class="chat-container mb-3">
                        {% for msg in messages %}
                            <div class="d-flex {% if msg.sender_id == current_user.id %}justify-content-end{% else %}justify-content-start{% endif %} mb-2">
                                {% if msg.sender_id != current_user.id %}
                                    <img src="{{ msg.sender.avatar(36) }}" class="rounded-circle me-2" style="width: 36px; height: 36px;">
                                {% endif %}
                                
                                <div class="message-bubble {% if msg.sender_id == current_user.id %}message-me{% else %}message-other{% endif %}">
                                    <div>{{ msg.body }}</div>
                                    <span class="message-time">{{ moment(msg.timestamp).format('LT') }}</span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <form method="POST" id="send-form" class="d-flex gap-2">
                        {{ form.hidden_tag() }}
                        {{ form.message(class="form-control", placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...", autocomplete="off") }}
                        {{ form.submit(class="btn btn-primary") }}
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function scrollToBottom() {
        var chatBox = document.getElementById("chat-box");
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    scrollToBottom();

    // AJAX Polling (URL API –Ω–µ –∑–º—ñ–Ω—é—î—Ç—å—Å—è, –±–æ –≤—ñ–Ω –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î url_for —Ç—É—Ç)
    setInterval(function() {
        fetch('/api/messages/{{ ann.id }}')
            .then(response => response.json())
            .then(data => {
                var chatBox = document.getElementById("chat-box");
                chatBox.innerHTML = ""; 

                data.forEach(msg => {
                    var alignClass = msg.is_me ? "justify-content-end" : "justify-content-start";
                    var bubbleClass = msg.is_me ? "message-me" : "message-other";
                    var avatarHtml = "";
                    
                    if (!msg.is_me) {
                        avatarHtml = `<img src="${msg.avatar}" class="rounded-circle me-2" style="width: 36px; height: 36px;">`;
                    }

                    var html = `
                        <div class="d-flex ${alignClass} mb-2">
                            ${avatarHtml}
                            <div class="message-bubble ${bubbleClass}">
                                <div>${msg.body}</div>
                                <span class="message-time">${msg.time}</span>
                            </div>
                        </div>
                    `;
                    chatBox.innerHTML += html;
                });
            });
    }, 3000);
</script>
{% endblock %}